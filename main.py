import logging
import asyncio
import os

from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import Message
from dotenv import load_dotenv
from openai import OpenAI
from keyboards import start_keyboard

load_dotenv()
TOKEN = "7513387599:AAFbyVW6uHhQP_C2jXdEJP4NkB3XStEu11M"


bot = Bot(token="7513387599:AAFbyVW6uHhQP_C2jXdEJP4NkB3XStEu11M")
OPENAI_API_KEY= os.getenv("OPENAI_API_KEY")


dp = Dispatcher()


logging.basicConfig(level=logging.INFO)




@dp.message(Command(commands=["start"]))
async def send_welcome(message: types.Message):
    logging.info("Команда /start получена")
    await message.answer(
        "Здравствуйте вас приветствует школьный бот\n"
        "Для получения расписания напишите команду:\n"
        "/schedule <класс> <день недели>\n"
        "Пример: /schedule 1-А Понедельник\n"
        "Для получения расписания собраний напишите команду:\n"
        "/meeting <класс>\n"
        "А так же для получения информации о школе напишите команду:\n"
        "/info\n"
        "Примечания букву а так же день недели писать с большой буквы и с помощью русского языка"
    )



@dp.message(Command(commands=["info"]))
async def send_info(message: types.Message):
    logging.info("Команда /info получена")
    info_text = (
    "Школа №29\n"
    "\nАдрес: ул.Солнечная 45, Бишкек, Кыргызстан\n"
    "\nШкола №29 — учебное заведение с углубленным изучением астрономии и космических наук."
    "Учебный процесс ориентирован на подготовку учеников к будущей карьере в области науки и технологий."
    "Школа оснащена современной лабораторией для экспериментов, а также имеет обсерваторию для наблюдений за небесными телами.\n"
    
    "\nШкола активно сотрудничает с международными научными центрами и регулярно организует научные конференции и выставки для учащихся и преподавателей."
    )
    await message.answer(info_text)






schedule = {

    "1-А": {
        "Понедельник": ["Математика", "Русский язык", "Физкультура"],
        "Вторник": ["Окружающий мир", "Чтение", "Музыка"],
        "Среда": ["Труд", "ИЗО", "Физкультура"],
        "Четверг": ["Математика", "Русский язык", "Чтение"],
        "Пятница": ["Музыка", "Окружающий мир", "Физкультура"]
    },
    "1-Б": {
        "Понедельник": ["Русский язык", "Математика", "ИЗО"],
        "Вторник": ["Физкультура", "Чтение", "Музыка"],
        "Среда": ["Окружающий мир", "Русский язык", "Труд"],
        "Четверг": ["Математика", "Музыка", "Физкультура"],
        "Пятница": ["Чтение", "ИЗО", "Труд"]
    },
    "1-В": {
        "Понедельник": ["Чтение", "Математика", "Физкультура"],
        "Вторник": ["Окружающий мир", "Русский язык", "Музыка"],
        "Среда": ["ИЗО", "Труд", "Физкультура"],
        "Четверг": ["Математика", "Чтение", "Русский язык"],
        "Пятница": ["Музыка", "Окружающий мир", "Труд"]
    },


    "2-А": {
        "Понедельник": ["Русский язык", "Математика", "Физкультура"],
        "Вторник": ["Окружающий мир", "Литература", "Музыка"],
        "Среда": ["Труд", "ИЗО", "Физкультура"],
        "Четверг": ["Математика", "Литература", "Русский язык"],
        "Пятница": ["Музыка", "Окружающий мир", "Физкультура"]
    },
    "2-Б": {
        "Понедельник": ["Математика", "Русский язык", "ИЗО"],
        "Вторник": ["Физкультура", "Литература", "Музыка"],
        "Среда": ["Окружающий мир", "Русский язык", "Труд"],
        "Четверг": ["Математика", "Музыка", "Физкультура"],
        "Пятница": ["Литература", "ИЗО", "Труд"]
    },
    "2-В": {
        "Понедельник": ["Литература", "Математика", "Физкультура"],
        "Вторник": ["Окружающий мир", "Русский язык", "Музыка"],
        "Среда": ["ИЗО", "Труд", "Физкультура"],
        "Четверг": ["Математика", "Литература", "Русский язык"],
        "Пятница": ["Музыка", "Окружающий мир", "Труд"]
    },


    "3-А": {
        "Понедельник": ["Математика", "Русский язык", "Физкультура"],
        "Вторник": ["Литература", "История", "Музыка"],
        "Среда": ["Биология", "География", "ИЗО"],
        "Четверг": ["Математика", "Обществознание", "Физкультура"],
        "Пятница": ["Труд", "Информатика", "Музыка"]
    },
    "3-Б": {
        "Понедельник": ["Русский язык", "Математика", "Труд"],
        "Вторник": ["История", "Литература", "Музыка"],
        "Среда": ["Биология", "География", "ИЗО"],
        "Четверг": ["Математика", "Физкультура", "Обществознание"],
        "Пятница": ["Информатика", "Музыка", "Физкультура"]
    },
    "3-В": {
        "Понедельник": ["Литература", "Математика", "Физкультура"],
        "Вторник": ["История", "Русский язык", "Музыка"],
        "Среда": ["Биология", "География", "Труд"],
        "Четверг": ["Математика", "Обществознание", "ИЗО"],
        "Пятница": ["Информатика", "Музыка", "Физкультура"]
    },


    "4-А": {
        "Понедельник": ["Математика", "Русский язык", "Физкультура"],
        "Вторник": ["Литература", "История", "ИЗО"],
        "Среда": ["Биология", "Окружающий мир", "Музыка"],
        "Четверг": ["Математика", "Труд", "Физкультура"],
        "Пятница": ["Информатика", "Обществознание", "Музыка"]
    },
    "4-Б": {
        "Понедельник": ["Русский язык", "Математика", "Труд"],
        "Вторник": ["История", "Литература", "Музыка"],
        "Среда": ["Биология", "География", "ИЗО"],
        "Четверг": ["Математика", "Физкультура", "Обществознание"],
        "Пятница": ["Информатика", "Музыка", "Физкультура"]
    },
    "4-В": {
        "Понедельник": ["Литература", "Математика", "Физкультура"],
        "Вторник": ["История", "Русский язык", "Музыка"],
        "Среда": ["Биология", "География", "Труд"],
        "Четверг": ["Математика", "Обществознание", "ИЗО"],
        "Пятница": ["Информатика", "Музыка", "Физкультура"]
    },


    "5-А": {
        "Понедельник": ["Математика", "История", "Физкультура"],
        "Вторник": ["Русский язык", "Литература", "ИЗО"],
        "Среда": ["География", "Технология", "Музыка"],
        "Четверг": ["Алгебра", "Биология", "Физкультура"],
        "Пятница": ["Обществознание", "Информатика", "Черчение"]
    },
    "5-Б": {
        "Понедельник": ["История", "Математика", "Труд"],
        "Вторник": ["Русский язык", "Литература", "Музыка"],
        "Среда": ["География", "Обществознание", "ИЗО"],
        "Четверг": ["Алгебра", "Физкультура", "Технология"],
        "Пятница": ["Информатика", "Биология", "Черчение"]
    },
    "5-В": {
        "Понедельник": ["Литература", "Математика", "Физкультура"],
        "Вторник": ["История", "Русский язык", "Музыка"],
        "Среда": ["Биология", "География", "Труд"],
        "Четверг": ["Алгебра", "Обществознание", "ИЗО"],
        "Пятница": ["Информатика", "Черчение", "Физкультура"]
    },

    "6-А": {
        "Понедельник": ["Алгебра", "Русский язык", "Физика"],
        "Вторник": ["История", "Литература", "Физкультура"],
        "Среда": ["Биология", "География", "ИЗО"],
        "Четверг": ["Информатика", "Труд", "Музыка"],
        "Пятница": ["Обществознание", "Химия", "Черчение"]
    },
    "6-Б": {
        "Понедельник": ["История", "Алгебра", "Физкультура"],
        "Вторник": ["Русский язык", "Литература", "ИЗО"],
        "Среда": ["География", "Физика", "Труд"],
        "Четверг": ["Информатика", "Музыка", "Биология"],
        "Пятница": ["Обществознание", "Химия", "Черчение"]
    },
    "6-В": {
        "Понедельник": ["Литература", "Алгебра", "Физика"],
        "Вторник": ["История", "Русский язык", "Физкультура"],
        "Среда": ["Биология", "География", "ИЗО"],
        "Четверг": ["Информатика", "Труд", "Музыка"],
        "Пятница": ["Обществознание", "Химия", "Черчение"]
    },


    "7-А": {
        "Понедельник": ["Алгебра", "Физика", "История"],
        "Вторник": ["Литература", "Английский язык", "Физкультура"],
        "Среда": ["Биология", "География", "Обществознание"],
        "Четверг": ["Химия", "Русский язык", "Информатика"],
        "Пятница": ["Черчение", "Труд", "Музыка"]
    },
    "7-Б": {
        "Понедельник": ["Физика", "Алгебра", "История"],
        "Вторник": ["Английский язык", "Литература", "Физкультура"],
        "Среда": ["География", "Биология", "Обществознание"],
        "Четверг": ["Русский язык", "Информатика", "Химия"],
        "Пятница": ["Музыка", "Черчение", "Труд"]
    },
    "7-В": {
        "Понедельник": ["История", "Физика", "Алгебра"],
        "Вторник": ["Литература", "Английский язык", "Физкультура"],
        "Среда": ["Обществознание", "География", "Биология"],
        "Четверг": ["Информатика", "Химия", "Русский язык"],
        "Пятница": ["Труд", "Музыка", "Черчение"]
    },


    "8-А": {
        "Понедельник": ["Геометрия", "Алгебра", "Физика"],
        "Вторник": ["История", "Английский язык", "Физкультура"],
        "Среда": ["Химия", "Биология", "Обществознание"],
        "Четверг": ["Литература", "Информатика", "Русский язык"],
        "Пятница": ["Черчение", "Музыка", "Труд"]
    },
    "8-Б": {
        "Понедельник": ["Алгебра", "Геометрия", "Физика"],
        "Вторник": ["Английский язык", "История", "Физкультура"],
        "Среда": ["Биология", "Химия", "Обществознание"],
        "Четверг": ["Русский язык", "Литература", "Информатика"],
        "Пятница": ["Музыка", "Черчение", "Труд"]
    },
    "8-В": {
        "Понедельник": ["Физика", "Алгебра", "Геометрия"],
        "Вторник": ["История", "Английский язык", "Физкультура"],
        "Среда": ["Обществознание", "Химия", "Биология"],
        "Четверг": ["Информатика", "Русский язык", "Литература"],
        "Пятница": ["Труд", "Музыка", "Черчение"]
    },


    "9-А": {
        "Понедельник": ["Физика", "Алгебра", "История"],
        "Вторник": ["Английский язык", "Литература", "Физкультура"],
        "Среда": ["Биология", "География", "Обществознание"],
        "Четверг": ["Русский язык", "Химия", "Информатика"],
        "Пятница": ["Черчение", "Музыка", "Труд"]
    },
    "9-Б": {
        "Понедельник": ["Алгебра", "Физика", "История"],
        "Вторник": ["Литература", "Английский язык", "Физкультура"],
        "Среда": ["Обществознание", "География", "Биология"],
        "Четверг": ["Информатика", "Русский язык", "Химия"],
        "Пятница": ["Музыка", "Черчение", "Труд"]
    },
    "9-В": {
        "Понедельник": ["История", "Физика", "Алгебра"],
        "Вторник": ["Английский язык", "Литература", "Физкультура"],
        "Среда": ["География", "Биология", "Обществознание"],
        "Четверг": ["Химия", "Русский язык", "Информатика"],
        "Пятница": ["Труд", "Музыка", "Черчение"]
    },


    "10-А": {
        "Понедельник": ["Алгебра", "Физика", "История"],
        "Вторник": ["Английский язык", "Литература", "Физкультура"],
        "Среда": ["Обществознание", "География", "Биология"],
        "Четверг": ["Русский язык", "Информатика", "Химия"],
        "Пятница": ["Экономика", "Черчение", "Музыка"]
    },
    "10-Б": {
        "Понедельник": ["Физика", "Алгебра", "История"],
        "Вторник": ["Литература", "Английский язык", "Физкультура"],
        "Среда": ["География", "Обществознание", "Биология"],
        "Четверг": ["Информатика", "Русский язык", "Химия"],
        "Пятница": ["Музыка", "Экономика", "Черчение"]
    },
    "10-В": {
        "Понедельник": ["История", "Физика", "Алгебра"],
        "Вторник": ["Английский язык", "Литература", "Физкультура"],
        "Среда": ["Обществознание", "География", "Биология"],
        "Четверг": ["Русский язык", "Химия", "Информатика"],
        "Пятница": ["Черчение", "Экономика", "Музыка"]
    },

    "11-А": {
        "Понедельник": ["Математика", "Русский язык", "Физика"],
        "Вторник": ["Литература", "Английский язык", "История"],
        "Среда": ["Обществознание", "Информатика", "Физкультура"],
        "Четверг": ["Биология", "География", "Химия"],
        "Пятница": ["Физика", "Экономика", "Музыка"]
    },
    "11-Б": {
        "Понедельник": ["Русский язык", "Математика", "История"],
        "Вторник": ["Физика", "Английский язык", "Литература"],
        "Среда": ["Обществознание", "Информатика", "Физкультура"],
        "Четверг": ["География", "Биология", "Химия"],
        "Пятница": ["Экономика", "Физика", "Музыка"]
    },
    "11-В": {
        "Понедельник": ["Литература", "Математика", "Физика"],
        "Вторник": ["Русский язык", "Английский язык", "История"],
        "Среда": ["Обществознание", "Информатика", "Физкультура"],
        "Четверг": ["Химия", "География", "Биология"],
        "Пятница": ["Музыка", "Экономика", "Физика"]
    }
    }


meetings_schedule = {
    "1-А": {
        "День недели": "Понедельник",
        "Время": "10:00",
        "Место": "Актовый зал"
    },
    "1-Б": {
        "День недели": "Вторник",
        "Время": "11:00",
        "Место": "Актовый зал"
    },
    "1-В": {
        "День недели": "Среда",
        "Время": "12:00",
        "Место": "Актовый зал"
    },
    "2-А": {
        "День недели": "Четверг",
        "Время": "09:00",
        "Место": "Кабинет 101"
    },
    "2-Б": {
        "День недели": "Пятница",
        "Время": "10:30",
        "Место": "Кабинет 102"
    },
    "2-В": {
        "День недели": "Понедельник",
        "Время": "11:30",
        "Место": "Кабинет 103"
    },
    "3-А": {
        "День недели": "Вторник",
        "Время": "09:00",
        "Место": "Кабинет 201"
    },
    "3-Б": {
        "День недели": "Среда",
        "Время": "10:00",
        "Место": "Кабинет 202"
    },
    "3-В": {
        "День недели": "Четверг",
        "Время": "11:00",
        "Место": "Кабинет 203"
    },
    "4-А": {
        "День недели": "Пятница",
        "Время": "09:30",
        "Место": "Актовый зал"
    },
    "4-Б": {
        "День недели": "Понедельник",
        "Время": "10:30",
        "Место": "Актовый зал"
    },
    "4-В": {
        "День недели": "Вторник",
        "Время": "11:00",
        "Место": "Кабинет 301"
    },
    "5-А": {
        "День недели": "Среда",
        "Время": "09:00",
        "Место": "Кабинет 401"
    },
    "5-Б": {
        "День недели": "Четверг",
        "Время": "10:00",
        "Место": "Кабинет 402"
    },
    "5-В": {
        "День недели": "Пятница",
        "Время": "11:00",
        "Место": "Кабинет 403"
    },
    "6-А": {
        "День недели": "Понедельник",
        "Время": "09:30",
        "Место": "Кабинет 501"
    },
    "6-Б": {
        "День недели": "Вторник",
        "Время": "10:30",
        "Место": "Кабинет 502"
    },
    "6-В": {
        "День недели": "Среда",
        "Время": "11:30",
        "Место": "Кабинет 503"
    },
    "7-А": {
        "День недели": "Четверг",
        "Время": "09:00",
        "Место": "Кабинет 601"
    },
    "7-Б": {
        "День недели": "Пятница",
        "Время": "10:00",
        "Место": "Кабинет 602"
    },
    "7-В": {
        "День недели": "Понедельник",
        "Время": "11:00",
        "Место": "Кабинет 603"
    },
    "8-А": {
        "День недели": "Вторник",
        "Время": "09:30",
        "Место": "Актовый зал"
    },
    "8-Б": {
        "День недели": "Среда",
        "Время": "10:30",
        "Место": "Актовый зал"
    },
    "8-В": {
        "День недели": "Четверг",
        "Время": "11:00",
        "Место": "Кабинет 701"
    },
    "9-А": {
        "День недели": "Пятница",
        "Время": "09:00",
        "Место": "Кабинет 801"
    },
    "9-Б": {
        "День недели": "Понедельник",
        "Время": "10:00",
        "Место": "Кабинет 802"
    },
    "9-В": {
        "День недели": "Вторник",
        "Время": "11:00",
        "Место": "Кабинет 803"
    },
    "10-А": {
        "День недели": "Среда",
        "Время": "09:30",
        "Место": "Кабинет 901"
    },
    "10-Б": {
        "День недели": "Четверг",
        "Время": "10:30",
        "Место": "Кабинет 902"
    },
    "10-В": {
        "День недели": "Пятница",
        "Время": "11:30",
        "Место": "Кабинет 903"
    },
    "11-А": {
        "День недели": "Понедельник",
        "Время": "09:00",
        "Место": "Актовый зал"
    },
    "11-Б": {
        "День недели": "Вторник",
        "Время": "10:00",
        "Место": "Актовый зал"
    },
    "11-В": {
        "День недели": "Среда",
        "Время": "11:00",
        "Место": "Кабинет 1001"
    }
}





@dp.message(Command(commands=["schedule"]))
async def get_schedule(message: types.Message):
    try:

        args = message.text.split()

        if len(args) < 3:
            await message.answer("Пожалуйста, укажите класс и день недели.\nПример: /schedule 1-А Понедельник")
            return

        class_name = args[1]
        day_of_week = args[2]


        if class_name in schedule:
            class_schedule = schedule[class_name]
            if day_of_week in class_schedule:
                subjects = class_schedule[day_of_week]
                response = f"Расписание для класса {class_name} на {day_of_week}:\n"
                response += "\n".join(subjects)
            else:
                response = f"Нет расписания для {day_of_week} в классе {class_name}."
        else:
            response = f"Класс {class_name} не найден."

        await message.answer(response)


    except Exception as e:
        await message.answer(f"Произошла ошибка: {str(e)}")




@dp.message(Command(commands=["meeting"]))
async def get_class_meeting(message: types.Message):
    try:

        args = message.text.split()

        if len(args) < 2:
            await message.answer("Пожалуйста, укажите класс. Пример: /meeting 1-А")
            return

        class_name = args[1].upper()


        if class_name in meetings_schedule:
            meeting_time = meetings_schedule[class_name]
            await message.answer(f"Собрание для класса {class_name}: {meeting_time}")
        else:
            await message.answer(f"Класс {class_name} не найден. Пожалуйста, проверьте название.")

    except Exception as e:
        await message.answer(f"Произошла ошибка: {str(e)}")

@dp.message()
async def chat_with_ai(message: Message):
    try:
        client = OpenAI(
            base_url="https://openrouter.ai/api/v1",
            api_key=f"{OPENAI_API_KEY}",
        )

        completion = client.chat.completions.create(
            model="google/gemma-3-27b-it:free",
            temperature=1,
            messages=[
                    {
                        "role": "user",
                        "content": message.text
                    },
                    {
                      "role": "system",
                      "content": "Ты мой помощник, Твоя роль отвечать на вопросы, чуть ниже я тебе напишу вопрос - ответ,а так же исправляй ошибки при написании команд "
                                 "если что используй их"
                                 "Количество учеников - 2528"
                                 "Количество учителей - 87"
                                 "Директор - Бахтияр Кадыров"


                  }
                ]
            )
        reply_text = completion.choices[0].message.content
        await message.answer(reply_text)
    except Exception as e:
        print(e)

async def main():
    print("Bot started...")
#   await db.connect()
    try:
        await dp.start_polling(bot)
    except Exception as e:
        print(e)
    finally:
        await db.disconnect()



if __name__ == '__main__':
    asyncio.run(main())










